<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Deepdive" />
    <link href='http://fonts.googleapis.com/css?family=Lato:300,400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="dennybritz.github.io/deepdive//stylesheets/application.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deepdive</title>
  </head>

  <body>
      
      <div id="header">
        <div class="container">
          <row>
            <div class="col-md-10 col-md-offset-1">
              <a href="/" class="deepdive-logo">DeepDive Logo comes here</a> 
            </div>
          </row>
        </div>
      </div>

      <section id="main">
        <div class="container">
          <row>
            <div class="col-md-10 col-md-offset-1">
              <h1 id="writing_extractors">Writing Extractors</h1>

<h3 id="defining_extractors_in_the_configuration_file">Defining extractors in the configuration file</h3>

<p>A feature extractor takes data defined by an arbitary SQL query as <code>input</code>, and produces new tuples as ouput. These tuples are written to the <code>output_relation</code>. The function for this transformation is defined by the <code>udf</code> key, which can be an arbitary executable (more on that below).</p>

<pre><code>deepdive.extractions: {
  wordsExtractor.output_relation: &quot;words&quot;
  wordsExtractor.input: &quot;SELECT * FROM titles&quot;
  wordsExtractor.udf: &quot;words.py&quot;
  # More Extractors...
}</code></pre>

<h3 id="extractor_dependencies">Extractor Dependencies</h3>

<p>You can also specify dependencies for an extractor. Extractors will be executed in order of their dependencies. If the dependencies of several extractors ar satisfied at the same time, these may be executed in parallel, or in any order.</p>

<pre><code>wordsExtractor.dependencies: [&quot;anotherExtractorName&quot;]</code></pre>

<h3 id="extractor_parallelism_and_input_batch_size">Extractor parallelism and input batch size</h3>

<p>To improve performance, you can specify the number of processes and the input batch size for each extractor. Your executable script will be run on N threads in parallel and data will be streamed to this processes in a round-robin fashion. By default each extractor uses 1 process and a batch size of 1000.</p>

<pre><code># Start 5 processes for this extractor
wordsExtractor.parallelism: 5
# Stream 1000 tuples to each process in a round-robin fashion
wordsExtractor.input_batch_size: 1000</code></pre>

<p>To improve performance when writing extracted data back to the database you can optionally specify an <code>output_batch_size</code> for each extractor. The output batch size specifies how many extracted tuples we insert into the database at once. For example, if your tuples are very large, a smaller batch size may help avoid out-of-memory errors. The default value is 10,000.</p>

<pre><code># Insert each 5000 tuples into the data store
wordsExtractor.output_batch_size: 5000</code></pre>

<h3 id="writing_extractor_udfs">Writing extractor UDFs</h3>

<p>When your extractor is executed, DeepDive will stream JSON tuples to its <em>stdin</em>, one tuple per line. Such a tuple may look as follows:</p>

<pre><code>{ id: 5, title: &quot;I am a title&quot; }</code></pre>

<p>The extractor should output JSON tuples to <em>stdout</em> in the same way, but <strong>without the <code>id</code> field</strong>, which is automatically assigned by DeepDive. All output tuples you must have the same fields. If you do not want to set a value for a field you can set it to <code>null</code>.</p>

<pre><code>{ title_id: 5, word: &quot;I&quot; } 
{ title_id: 5, word: &quot;am&quot; } 
{ title_id: 5, word: &quot;a&quot; } 
{ title_id: 5, word: &quot;title&quot; } </code></pre>

<p>An extractor UDF could be written in Python as follows:</p>
<div class='highlight'><pre><code class='python'><span class='c'>#! /usr/bin/env python</span>

<span class='kn'>import</span> <span class='nn'>fileinput</span>
<span class='kn'>import</span> <span class='nn'>json</span>

<span class='c'># For each input row</span>
<span class='k'>for</span> <span class='n'>line</span> <span class='ow'>in</span> <span class='n'>fileinput</span><span class='o'>.</span><span class='n'>input</span><span class='p'>():</span>
  <span class='n'>row</span> <span class='o'>=</span> <span class='n'>json</span><span class='o'>.</span><span class='n'>loads</span><span class='p'>(</span><span class='n'>line</span><span class='p'>)</span>
  <span class='k'>if</span> <span class='n'>row</span><span class='p'>[</span><span class='s'>&quot;titles.title&quot;</span><span class='p'>]</span> <span class='ow'>is</span> <span class='ow'>not</span> <span class='bp'>None</span><span class='p'>:</span>
    <span class='k'>for</span> <span class='n'>word</span> <span class='ow'>in</span> <span class='nb'>set</span><span class='p'>(</span><span class='n'>row</span><span class='p'>[</span><span class='s'>&quot;titles.title&quot;</span><span class='p'>]</span><span class='o'>.</span><span class='n'>split</span><span class='p'>(</span><span class='s'>&quot; &quot;</span><span class='p'>)):</span>
      <span class='k'>print</span> <span class='n'>json</span><span class='o'>.</span><span class='n'>dumps</span><span class='p'>({</span>
        <span class='s'>&quot;title_id&quot;</span><span class='p'>:</span> <span class='nb'>int</span><span class='p'>(</span><span class='n'>row</span><span class='p'>[</span><span class='s'>&quot;titles.id&quot;</span><span class='p'>]),</span> 
        <span class='s'>&quot;word&quot;</span><span class='p'>:</span> <span class='n'>word</span>
      <span class='p'>})</span>
</code></pre></div>
            </div>
          </row>
        </div>
      </section>
    
      <footer id="footer">
        <div class="container">
          <row>
            <div class="col-md-10 col-md-offset-1">
              <!-- <p class="copyright">Deepdive maintained by <a href="https://github.com/dennybritz">dennybritz</a></p> -->
            </div>
          </row>
        </div>
      </footer>

    
  
  </body>
</html>